apiVersion: v1
kind: Pod
metadata:
  name: deepti-debug
  namespace: mllm-interpretation-and-failure-investigation-c8fa7f
  labels:
    app: deepti-debug
spec:
  restartPolicy: Never
  tolerations:
  - key: "nvidia.com/gpu.product"
    operator: "Equal"
    value: "NVIDIA-H100-80GB-HBM3"
    effect: "NoSchedule"
  containers:
  - name: qwen-omni
    image: quay.io/jschless/ml-dev-env:latest
    command:
    - /bin/bash
    - -c
    - |
      set -e
      echo "=========================================="
      echo "Qwen2.5-Omni Debug Session (NERC Production)"
      echo "=========================================="
      echo ""
      echo "Namespace: mllm-interpretation-and-failure-investigation-c8fa7f"
      echo "GPUs: 4x NVIDIA H100 80GB HBM3"
      echo ""
      
      cp /scripts/deepti.py /workspace/deepti.py
      echo "Copied deepti.py to workspace"
      echo ""
      
      echo "Starting debugpy server on port 5678..."
      echo "Waiting for VSCode debugger to connect..."
      echo ""
      echo "To connect:"
      echo "  1. Port forward: oc port-forward deepti-debug 5678:5678 -n mllm-interpretation-and-failure-investigation-c8fa7f"
      echo "  2. Open VSCode and press F5"
      echo ""
      
      cd /workspace
      # Run with debugpy, wait for client to attach
      python -m debugpy --listen 0.0.0.0:5678 --wait-for-client deepti.py
    resources:
      requests:
        nvidia.com/gpu: 4
        memory: 8Gi
        cpu: 4
      limits:
        nvidia.com/gpu: 4
        memory: 10Gi
        cpu: 8
    ports:
    - containerPort: 5678
      name: debugpy
      protocol: TCP
    env:
    - name: CUDA_VISIBLE_DEVICES
      value: "0,1,2,3"
    - name: TRANSFORMERS_CACHE
      value: /workspace/.cache/transformers
    - name: HF_HOME
      value: /workspace/.cache/huggingface
    - name: TRITON_CACHE_DIR
      value: /workspace/.triton
    - name: NCCL_IB_DISABLE
      value: "1"
    - name: NCCL_DEBUG
      value: "INFO"
    - name: NCCL_P2P_LEVEL
      value: "NVL"
    volumeMounts:
    - name: deepti-script
      mountPath: /scripts
    - name: workspace
      mountPath: /workspace
  volumes:
  - name: deepti-script
    configMap:
      name: deepti-script
  - name: workspace
    emptyDir: {}
