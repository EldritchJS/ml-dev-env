apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: ml-dev-env-pytorch28
  namespace: nccl-test
  labels:
    app: ml-dev-env
    pytorch-version: "2.8"
    numpy-version: "1.26.4"
spec:
  output:
    to:
      kind: ImageStreamTag
      name: ml-dev-env:pytorch-2.8-numpy1
  source:
    type: Dockerfile
    dockerfile: |
      # ML Development Environment - NVIDIA PyTorch Base
      # Uses NVIDIA's official PyTorch container for guaranteed CUDA compatibility
      # Using 25.08 which includes PyTorch 2.8 (fixes CVE-2025-32434)
      # flash-attn 2.7.4.post1 is pre-installed and tested by NVIDIA

      FROM nvcr.io/nvidia/pytorch:25.08-py3 AS base

      # Set environment variables
      ENV PYTHONUNBUFFERED=1 \
          DEBIAN_FRONTEND=noninteractive

      # Install system dependencies using apt (Ubuntu base)
      RUN apt-get update && apt-get install -y \
          git \
          wget \
          vim \
          less \
          bash-completion \
          gcc \
          g++ \
          make \
          cmake \
          ninja-build \
          ffmpeg \
          curl \
          && rm -rf /var/lib/apt/lists/*

      # Install RDMA/InfiniBand tools
      RUN apt-get update && apt-get install -y \
          libibverbs-dev \
          librdmacm-dev \
          rdma-core \
          infiniband-diags \
          pciutils \
          numactl \
          && rm -rf /var/lib/apt/lists/*

      # PyTorch is already installed in the base image
      # Upgrade pip and install base packages
      RUN pip install --no-cache-dir --upgrade pip setuptools wheel

      # Set NCCL environment variables for RDMA/GPUDirect
      ENV NCCL_DEBUG=INFO \
          NCCL_IB_DISABLE=0 \
          NCCL_IB_HCA=mlx5_6,mlx5_7,mlx5_10,mlx5_11 \
          NCCL_IB_GID_INDEX=3 \
          NCCL_SOCKET_IFNAME=net1,net2,net3,net4 \
          NCCL_NET_GDR_LEVEL=5

      # Install build tools (may be needed by other packages)
      RUN pip install --no-cache-dir packaging ninja wheel

      # Install transformers and related libraries
      # NOTE: transformers must be installed alone to avoid PyTorch upgrades
      RUN pip install --no-cache-dir transformers>=4.37.0

      RUN pip install --no-cache-dir \
          accelerate \
          datasets \
          tokenizers \
          sentencepiece \
          protobuf

      # CRITICAL: Pin PyTorch before installing packages that might upgrade it
      # Create constraints file to prevent PyTorch upgrades
      RUN python -c "import torch; print(f'torch=={torch.__version__}')" > /tmp/constraints.txt && \
          cat /tmp/constraints.txt

      # Install deepspeed with PyTorch pinned
      RUN pip install --no-cache-dir --constraint /tmp/constraints.txt deepspeed

      # Install LLaMAFactory and its dependencies with PyTorch pinned
      RUN pip install --no-cache-dir --constraint /tmp/constraints.txt \
          llamafactory \
          peft \
          trl \
          bitsandbytes

      # Install VideoLLaMA2 dependencies
      RUN pip install --no-cache-dir \
          einops \
          timm \
          av \
          opencv-python \
          decord

      # Install Qwen2.5-Omni utilities
      RUN pip install --no-cache-dir qwen-omni-utils || \
          pip install --no-cache-dir qwen-omni-utils[decord]

      # Install EasyR1 and additional ML tools
      RUN pip install --no-cache-dir \
          scipy \
          scikit-learn \
          matplotlib \
          jupyter \
          ipykernel \
          notebook

      # Install development tools
      RUN pip install --no-cache-dir \
          ipython \
          debugpy \
          pytest \
          black \
          flake8 \
          tensorboard \
          wandb

      # NumPy 1.x Required: PyTorch 2.8 has binary incompatibility with NumPy 2.x
      # NVIDIA's PyTorch 2.8 (from image 25.08) was compiled against NumPy 1.x
      # Attempting to use NumPy 2.x causes: "A module that was compiled using NumPy 1.x cannot be run in NumPy 2.x"
      # qwen-omni-utils downgrades to NumPy 1.26.4, but opencv-python upgrades to NumPy 2.x
      # This final downgrade ensures NumPy 1.26.4 for PyTorch 2.8 compatibility
      # Note: PyTorch 2.9 (image 25.09) is compatible with NumPy 2.x - use pytorch-2.9-numpy2 tag for that
      RUN pip install --no-cache-dir --force-reinstall --no-deps "numpy<2.0"

      # NOTE: Using pre-installed flash-attn 2.7.4.post1 from NVIDIA PyTorch 25.08 base image
      # The base image includes flash-attn built specifically for NVIDIA's PyTorch 2.8
      # This version is tested by NVIDIA and avoids symbol mismatches

      # Install code-server (VSCode in browser)
      RUN curl -fsSL https://code-server.dev/install.sh | sh

      # Create workspace directory
      RUN mkdir -p /workspace

      # Configure bash completion
      RUN echo "if [ -f /usr/share/bash-completion/bash_completion ]; then" >> /root/.bashrc && \
          echo "  source /usr/share/bash-completion/bash_completion" >> /root/.bashrc && \
          echo "fi" >> /root/.bashrc && \
          echo "export PS1='\\[\\033[01;32m\\]\\u@ml-dev\\[\\033[00m\\]:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ '" >> /root/.bashrc && \
          echo "alias ll='ls -lah'" >> /root/.bashrc

      # Set working directory
      WORKDIR /workspace

      # Expose ports for code-server, jupyter, tensorboard
      EXPOSE 8080 8888 6006

      # Create entrypoint script
      RUN echo '#!/bin/bash' > /entrypoint.sh && \
          echo 'echo "=========================================="' >> /entrypoint.sh && \
          echo 'echo "ML Development Environment (PyTorch 2.8 + NumPy 1.x)"' >> /entrypoint.sh && \
          echo 'echo "=========================================="' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "GPU Information:"' >> /entrypoint.sh && \
          echo 'nvidia-smi --query-gpu=name,memory.total,compute_cap --format=csv,noheader' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "GPU Topology:"' >> /entrypoint.sh && \
          echo 'nvidia-smi topo -m' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "InfiniBand Devices:"' >> /entrypoint.sh && \
          echo 'ibstat 2>/dev/null || echo "  No IB devices found (may need host network)"' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "Python version:"' >> /entrypoint.sh && \
          echo 'python --version' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "PyTorch version:"' >> /entrypoint.sh && \
          echo 'python -c "import torch; print(f\"PyTorch {torch.__version__}, CUDA available: {torch.cuda.is_available()}, CUDA version: {torch.version.cuda}\")"' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "Installed packages:"' >> /entrypoint.sh && \
          echo 'echo "  - transformers: $(python -c \"import transformers; print(transformers.__version__)\")"' >> /entrypoint.sh && \
          echo 'echo "  - deepspeed: $(python -c \"import deepspeed; print(deepspeed.__version__)\")"' >> /entrypoint.sh && \
          echo 'echo "  - flash-attn: installed"' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'echo "Base Image: NVIDIA PyTorch (Ubuntu 22.04)"' >> /entrypoint.sh && \
          echo 'echo "=========================================="' >> /entrypoint.sh && \
          echo 'echo "VSCode Server: http://localhost:8080"' >> /entrypoint.sh && \
          echo 'echo "Jupyter: http://localhost:8888"' >> /entrypoint.sh && \
          echo 'echo "TensorBoard: http://localhost:6006"' >> /entrypoint.sh && \
          echo 'echo "=========================================="' >> /entrypoint.sh && \
          echo 'echo ""' >> /entrypoint.sh && \
          echo 'exec "$@"' >> /entrypoint.sh && \
          chmod +x /entrypoint.sh

      ENTRYPOINT ["/entrypoint.sh"]
      CMD ["tail", "-f", "/dev/null"]
  strategy:
    type: Docker
    dockerStrategy:
      dockerfilePath: Dockerfile
  triggers:
    - type: ConfigChange
